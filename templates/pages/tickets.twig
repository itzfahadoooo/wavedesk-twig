{% extends "base.twig" %}

{% block title %}Tickets | WaveDesk{% endblock %}

{% block content %}
  {% include "components/navbar.twig" %}
  {% include "components/flash.twig" %}

  <div class="min-h-screen bg-gradient-to-b from-white to-blue-50 flex flex-col">
    <main class="flex-1 max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-12">
      <div class="flex items-center justify-between mb-12">
        <div>
          <h1 class="text-4xl font-bold text-gray-900 mb-2">Tickets</h1>
          <p class="text-gray-600">Manage and track all your support tickets</p>
        </div>

        <button 
          onclick="openCreateModal()"
          class="flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium"
        >
          <i data-lucide="plus" class="w-5 h-5"></i>
          New Ticket
        </button>
      </div>

      {% if tickets is empty %}
        <div class="bg-white rounded-2xl p-12 text-center border border-blue-100">
          <div class="mb-4">
            <i data-lucide="inbox" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
          </div>
          <p class="text-gray-600 mb-4 text-lg">
            No tickets yet. Create one to get started!
          </p>
          <button
            onclick="openCreateModal()"
            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium"
          >
            Create First Ticket
          </button>
        </div>
      {% else %}
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {% for ticket in tickets %}
            {% include "components/ticket_card.twig" with { ticket: ticket } %}
          {% endfor %}
        </div>
      {% endif %}
    </main>

    {% include "components/footer.twig" %}
  </div>

  <!-- Create Ticket Modal -->
  {% include "components/modal.twig" with {
    modalId: 'createTicketModal',
    title: 'Create New Ticket'
  } %}

  <!-- Edit Ticket Modal -->
  <div id="editTicketModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-2 sm:p-4">
    <div class="modal-backdrop absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeModal('editTicketModal')"></div>
    
    <div class="modal-content relative bg-white rounded-xl sm:rounded-2xl shadow-2xl w-full max-w-[95vw] sm:max-w-md mx-auto max-h-[85vh] sm:max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
      <div class="sticky top-0 bg-white z-10 flex items-center justify-between p-4 sm:p-6 border-b border-blue-100 rounded-t-xl sm:rounded-t-2xl">
        <h2 class="text-lg sm:text-xl font-bold text-gray-900 pr-4">Edit Ticket</h2>
        <button type="button" onclick="closeModal('editTicketModal')" class="flex-shrink-0 p-1 sm:p-2 hover:bg-gray-100 rounded-lg transition-colors">
          <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
        </button>
      </div>

      <div class="p-4 sm:p-6">
        <form method="POST" action="/" class="space-y-4" id="editTicketForm">
          <input type="hidden" name="action" value="update_ticket">
          <input type="hidden" name="ticket_id" id="edit_ticket_id">

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Title <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              name="title"
              id="edit_title"
              placeholder="Brief description of the issue"
              required
              class="w-full px-3 sm:px-4 py-2 text-sm sm:text-base border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 border-gray-300 transition"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Description <span class="text-red-500">*</span>
            </label>
            <textarea
              name="description"
              id="edit_description"
              rows="4"
              placeholder="Detailed description of the issue..."
              required
              class="w-full px-3 sm:px-4 py-2 text-sm sm:text-base border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 border-gray-300 transition resize-none"
            ></textarea>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Priority <span class="text-red-500">*</span>
              </label>
              <select
                name="priority"
                id="edit_priority"
                required
                class="w-full px-3 sm:px-4 py-2 text-sm sm:text-base border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 border-gray-300 transition"
              >
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Status <span class="text-red-500">*</span>
              </label>
              <select
                name="status"
                id="edit_status"
                required
                class="w-full px-3 sm:px-4 py-2 text-sm sm:text-base border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 border-gray-300 transition"
              >
                <option value="open">Open</option>
                <option value="in_progress">In Progress</option>
                <option value="closed">Closed</option>
              </select>
            </div>
          </div>

          <div class="flex flex-col sm:flex-row gap-3 pt-4">
            <button
              type="button"
              onclick="closeModal('editTicketModal')"
              class="w-full sm:flex-1 px-4 py-2.5 sm:py-2 text-sm sm:text-base bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition font-medium"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="w-full sm:flex-1 px-4 py-2.5 sm:py-2 text-sm sm:text-base bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium"
            >
              Update Ticket
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteTicketModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-2 sm:p-4">
    <div class="modal-backdrop absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeModal('deleteTicketModal')"></div>
    
    <div class="modal-content relative bg-white rounded-xl sm:rounded-2xl shadow-2xl w-full max-w-[95vw] sm:max-w-sm mx-auto" onclick="event.stopPropagation()">
      <div class="p-4 sm:p-6">
        <div class="flex items-center justify-center w-12 h-12 mx-auto mb-4 bg-red-100 rounded-full">
          <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
        </div>
        
        <h2 class="text-lg sm:text-xl font-bold text-gray-900 text-center mb-2">Delete Ticket</h2>
        <p class="text-sm sm:text-base text-gray-600 text-center mb-6">
          Are you sure you want to delete "<span id="delete_ticket_title" class="font-semibold"></span>"? This action cannot be undone.
        </p>

        <form method="POST" action="/" id="deleteTicketForm">
          <input type="hidden" name="action" value="delete_ticket">
          <input type="hidden" name="ticket_id" id="delete_ticket_id">

          <div class="flex flex-col sm:flex-row gap-3">
            <button
              type="button"
              onclick="closeModal('deleteTicketModal')"
              class="w-full sm:flex-1 px-4 py-2.5 sm:py-2 text-sm sm:text-base bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition font-medium"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="w-full sm:flex-1 px-4 py-2.5 sm:py-2 text-sm sm:text-base bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium"
            >
              Delete
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteTicketModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeModal('deleteTicketModal')"></div>
    
    <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto">
      <div class="p-6">
        <div class="flex items-center justify-center w-12 h-12 mx-auto mb-4 bg-red-100 rounded-full">
          <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
        </div>
        
        <h2 class="text-xl font-bold text-gray-900 text-center mb-2">Delete Ticket</h2>
        <p class="text-gray-600 text-center mb-6">
          Are you sure you want to delete "<span id="delete_ticket_title" class="font-semibold"></span>"? This action cannot be undone.
        </p>

        <form method="POST" action="/" id="deleteTicketForm">
          <input type="hidden" name="action" value="delete_ticket">
          <input type="hidden" name="ticket_id" id="delete_ticket_id">

          <div class="flex gap-3">
            <button
              type="button"
              onclick="closeModal('deleteTicketModal')"
              class="flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition font-medium"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium"
            >
              Delete
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    function openCreateModal() {
      document.getElementById('createTicketModal').classList.remove('hidden');
      lucide.createIcons();
    }

    function openEditModal(id, title, description, status, priority) {
      document.getElementById('edit_ticket_id').value = id;
      document.getElementById('edit_title').value = title;
      document.getElementById('edit_description').value = description;
      document.getElementById('edit_status').value = status;
      document.getElementById('edit_priority').value = priority;
      document.getElementById('editTicketModal').classList.remove('hidden');
      lucide.createIcons();
    }

    function confirmDelete(id, title) {
      document.getElementById('delete_ticket_id').value = id;
      document.getElementById('delete_ticket_title').textContent = title;
      document.getElementById('deleteTicketModal').classList.remove('hidden');
      lucide.createIcons();
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
    }

    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal('createTicketModal');
        closeModal('editTicketModal');
        closeModal('deleteTicketModal');
      }
    });
  </script>
{% endblock %}